@model IEnumerable<HiveQ.Models.QueueEntry>

@{
    ViewData["Title"] = "My Queues";
}

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="mb-4">
            <h1>My Queues</h1>
            <p class="lead">Queues you're currently waiting in</p>
        </div>

        @if (TempData["Message"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @TempData["Message"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (!User.Identity?.IsAuthenticated ?? true)
        {
            <div class="alert alert-info">
                <h5 class="alert-heading">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                    </svg>
                    Guest Users
                </h5>
                <p class="mb-0">As a guest, please bookmark your queue position page to check your status. <a asp-controller="Account" asp-action="Register" class="alert-link">Register for an account</a> to see all your queues in one place.</p>
            </div>
        }

        @if (Model != null && Model.Any())
        {
            <div class="row">
                @foreach (var entry in Model)
                {
                    var currentPosition = Model.Where(e => e.QueueId == entry.QueueId && 
                                                          (e.Status == "Waiting" || e.Status == "Notified") && 
                                                          e.PositionNumber <= entry.PositionNumber).Count();
                    var peopleAhead = currentPosition - 1;
                    var estimatedWait = peopleAhead * entry.Queue.EstimatedWaitTimePerPerson;

                    <div class="col-md-6 mb-4">
                        <div class="card @(entry.Status == "Notified" ? "border-warning" : "")">
                            <div class="card-header d-flex justify-content-between align-items-center @(entry.Status == "Notified" ? "bg-warning" : "")">
                                <h5 class="mb-0">@entry.Queue.QueueName</h5>
                                @if (entry.Status == "Waiting")
                                {
                                    <span class="badge bg-info">Waiting</span>
                                }
                                else if (entry.Status == "Notified")
                                {
                                    <span class="badge bg-danger">YOUR TURN!</span>
                                }
                            </div>
                            <div class="card-body">
                                @if (entry.Status == "Notified")
                                {
                                    <div class="alert alert-warning mb-3">
                                        <strong>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bell-fill" viewBox="0 0 16 16">
                                                <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901z"/>
                                            </svg>
                                            It's your turn! Please proceed to the service area.
                                        </strong>
                                    </div>
                                }

                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <h2 class="@(entry.Status == "Notified" ? "text-danger" : "text-primary") mb-0">@currentPosition</h2>
                                        <small class="text-muted">Your Position</small>
                                    </div>
                                    <div class="col-4">
                                        <h2 class="text-muted mb-0">@peopleAhead</h2>
                                        <small class="text-muted">Ahead of You</small>
                                    </div>
                                    <div class="col-4">
                                        <h2 class="text-warning mb-0">~@estimatedWait</h2>
                                        <small class="text-muted">Minutes</small>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <small class="text-muted">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-clock" viewBox="0 0 16 16">
                                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                        </svg>
                                        Joined at @entry.JoinedAt.ToLocalTime().ToString("h:mm tt")
                                    </small>
                                </div>

                                <hr />

                                <div class="d-grid gap-2">
                                    <a asp-controller="JoinQueue" asp-action="ViewPosition" asp-route-queueEntryId="@entry.QueueEntryId" 
                                       class="btn @(entry.Status == "Notified" ? "btn-warning" : "btn-primary")">
                                        @if (entry.Status == "Notified")
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                            </svg>
                                            @:View Details & Respond
                                        }
                                        else
                                        {
                                            <text>View Full Details</text>
                                        }
                                    </a>
                                    
                                    <form method="post" asp-controller="JoinQueue" asp-action="Leave" asp-route-queueEntryId="@entry.QueueEntryId" 
                                          onsubmit="return confirm('Are you sure you want to leave this queue?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger w-100">Leave Queue</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" class="bi bi-inbox text-muted" viewBox="0 0 16 16">
                    <path d="M4.98 4a.5.5 0 0 0-.39.188L1.54 8H6a.5.5 0 0 1 .5.5 1.5 1.5 0 1 0 3 0A.5.5 0 0 1 10 8h4.46l-3.05-3.812A.5.5 0 0 0 11.02 4H4.98zm9.954 5H10.45a2.5 2.5 0 0 1-4.9 0H1.066l.32 2.562a.5.5 0 0 0 .497.438h12.234a.5.5 0 0 0 .496-.438L14.933 9zM3.809 3.563A1.5 1.5 0 0 1 4.981 3h6.038a1.5 1.5 0 0 1 1.172.563l3.7 4.625a.5.5 0 0 1 .106.374l-.39 3.124A1.5 1.5 0 0 1 14.117 13H1.883a1.5 1.5 0 0 1-1.489-1.314l-.39-3.124a.5.5 0 0 1 .106-.374l3.7-4.625z"/>
                </svg>
                <h3 class="mt-4 text-muted">Not in Any Queues</h3>
                <p class="text-muted">Browse available queues on the home page to join</p>
                <a asp-controller="Home" asp-action="Index" class="btn btn-primary mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    Browse Queues
                </a>
            </div>
        }
    </div>
</div>

<script>
    // Auto-refresh every 15 seconds
    setTimeout(function() {
        location.reload();
    }, 15000);
</script>
